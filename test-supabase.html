<!DOCTYPE html>
<html>
<head>
    <title>Supabase Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .loading { color: #f59e0b; }
        pre { background: #f3f4f6; padding: 15px; border-radius: 8px; overflow: auto; }
        button { 
            padding: 10px 20px; 
            background: #3b82f6; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        .status-box { 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Supabase Connection Test</h1>
    
    <div>
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="createTestTable()">Create Test Table</button>
        <button onclick="insertTestData()">Insert Test Data</button>
        <button onclick="viewTables()">View All Data</button>
    </div>
    
    <div id="status" class="loading">Click "Test Connection" to start</div>
    <pre id="result"></pre>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
        
        // === ENTER YOUR CREDENTIALS HERE ===
        const supabaseUrl = 'https://YOUR-PROJECT-REF.supabase.co'
        const supabaseKey = 'YOUR-ANON-KEY-HERE'
        
        if (supabaseUrl.includes('YOUR-PROJECT') || supabaseKey.includes('YOUR-ANON')) {
            document.getElementById('status').innerHTML = 
                '<div class="error status-box">‚ùå Please enter your Supabase credentials in the JavaScript code!</div>';
            document.getElementById('result').textContent = 
                'Open test-supabase.html in a text editor and replace:\n' +
                '1. supabaseUrl with: https://your-project-ref.supabase.co\n' +
                '2. supabaseKey with your anon/public key\n\n' +
                'Get these from: Supabase Dashboard ‚Üí Project Settings ‚Üí API';
            throw new Error('Please update Supabase credentials');
        }
        
        const supabase = createClient(supabaseUrl, supabaseKey)
        
        function updateStatus(message, type = 'loading') {
            const status = document.getElementById('status')
            status.innerHTML = `<div class="${type} status-box">${message}</div>`
        }
        
        function updateResult(content) {
            document.getElementById('result').textContent = content
        }
        
        async function testConnection() {
            updateStatus('üîå Testing connection to Supabase...', 'loading')
            
            try {
                // Try to get database server info
                const { data, error } = await supabase
                    .from('_health')
                    .select('*')
                    .limit(1)
                
                if (error) {
                    // Try alternative method
                    const { error: altError } = await supabase
                        .from('appointments')
                        .select('id')
                        .limit(1)
                    
                    if (altError) {
                        if (altError.code === '42P01') {
                            updateStatus('‚úÖ Connected! (Tables not created yet)', 'success')
                            updateResult(`Success! Supabase is connected.\n\n` +
                                `Project URL: ${supabaseUrl}\n` +
                                `Error (expected): ${altError.message}\n\n` +
                                `Next step: Create tables using the SQL schema.`)
                        } else {
                            updateStatus('‚ùå Connection failed', 'error')
                            updateResult(`Error: ${JSON.stringify(altError, null, 2)}`)
                        }
                    } else {
                        updateStatus('‚úÖ Connected and tables exist!', 'success')
                        updateResult('Success! Supabase is connected and tables are accessible.')
                    }
                } else {
                    updateStatus('‚úÖ Connected! Health check passed.', 'success')
                    updateResult(`Success! Connection established.\n\nHealth data: ${JSON.stringify(data, null, 2)}`)
                }
                
            } catch (err) {
                updateStatus('‚ùå Connection failed', 'error')
                updateResult(`Exception: ${err.message}\n\n` +
                    `Common issues:\n` +
                    `1. Wrong URL or API key\n` +
                    `2. CORS not configured in Supabase\n` +
                    `3. Project paused or deleted\n` +
                    `4. Network/firewall blocking connection`)
            }
        }
        
        async function createTestTable() {
            updateStatus('Creating test table...', 'loading')
            
            // Run SQL to create a test table
            const sql = `
                CREATE TABLE IF NOT EXISTS test_connection (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    test_message TEXT,
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW())
                );
                
                COMMENT ON TABLE test_connection IS 'Table for testing Supabase connection';
            `
            
            try {
                const { error } = await supabase.rpc('exec_sql', { sql })
                
                if (error) {
                    updateStatus('‚ö†Ô∏è Could not create table via RPC', 'loading')
                    updateResult(`Note: Direct SQL execution requires special permissions.\n\n` +
                                `Error: ${error.message}\n\n` +
                                `You can create tables in Supabase Dashboard ‚Üí SQL Editor.`)
                } else {
                    updateStatus('‚úÖ Test table created!', 'success')
                    updateResult('Test table "test_connection" created successfully.')
                }
            } catch (err) {
                updateStatus('‚ùå Failed to create table', 'error')
                updateResult(`Error: ${err.message}`)
            }
        }
        
        async function insertTestData() {
            updateStatus('Inserting test data...', 'loading')
            
            const testData = {
                test_message: 'Test connection from website - ' + new Date().toISOString()
            }
            
            try {
                const { data, error } = await supabase
                    .from('test_connection')
                    .insert([testData])
                    .select()
                
                if (error) {
                    updateStatus('‚ùå Insert failed', 'error')
                    updateResult(`Error: ${JSON.stringify(error, null, 2)}\n\n` +
                                `Make sure the test_connection table exists.`)
                } else {
                    updateStatus('‚úÖ Test data inserted!', 'success')
                    updateResult(`Inserted data: ${JSON.stringify(data, null, 2)}`)
                }
            } catch (err) {
                updateStatus('‚ùå Insert failed', 'error')
                updateResult(`Exception: ${err.message}`)
            }
        }
        
        async function viewTables() {
            updateStatus('Fetching data...', 'loading')
            
            try {
                // Try to get list of tables (this may not work without proper permissions)
                const { data: tables, error: tablesError } = await supabase
                    .from('test_connection')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10)
                
                if (tablesError) {
                    updateStatus('‚ö†Ô∏è Could not fetch data', 'loading')
                    updateResult(`Error: ${tablesError.message}\n\n` +
                                `Tables might not exist yet. Create them first.`)
                } else {
                    updateStatus(`‚úÖ Found ${tables.length} records`, 'success')
                    updateResult(`Latest records:\n\n${JSON.stringify(tables, null, 2)}`)
                }
            } catch (err) {
                updateStatus('‚ùå Failed to fetch data', 'error')
                updateResult(`Exception: ${err.message}`)
            }
        }
    </script>
</body>
</html>